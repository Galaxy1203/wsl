<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“¶æ²³ç³»æ‰‹åŠ¿æ§åˆ¶æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        #galaxy-canvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }

        #camera-preview {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 240px;
            height: 180px;
            border: 2px solid #fff;
            border-radius: 8px;
            z-index: 3;
            transform: scaleX(-1);
            background: rgba(0, 0, 0, 0.5);
        }

        #controls {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #fff;
            z-index: 3;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
        }

        #gesture-status {
            margin-top: 10px;
            font-weight: bold;
            color: #00ff00;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 24px;
            z-index: 10;
            text-align: center;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div>æ­£åœ¨åŠ è½½æ¨¡å‹...</div>
        <div class="spinner"></div>
    </div>

    <canvas id="galaxy-canvas"></canvas>
    <video id="camera-preview" autoplay playsinline></video>

    <div id="controls">
        <h3>ğŸ® é“¶æ²³ç³»æ‰‹åŠ¿æ§åˆ¶</h3>
        <p>âœ‹ å¼ å¼€æ‰‹æŒ‡ - æ”¾å¤§æ˜Ÿç³»</p>
        <p>âœŠ æåˆæ‰‹æŒ‡ - ç¼©å°æ˜Ÿç³»</p>
        <div id="gesture-status">ç­‰å¾…æ£€æµ‹...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <script>
        // æ˜Ÿç³»ç”»å¸ƒè®¾ç½®
        const galaxyCanvas = document.getElementById('galaxy-canvas');
        const galaxyCtx = galaxyCanvas.getContext('2d');
        let galaxyScale = 1.0;
        const minScale = 0.3;
        const maxScale = 3.0;

        function resizeCanvas() {
            galaxyCanvas.width = window.innerWidth;
            galaxyCanvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ç”Ÿæˆæ˜Ÿæ˜Ÿ
        const stars = [];
        const numStars = 1500;
        for (let i = 0; i < numStars; i++) {
            stars.push({
                x: Math.random() * 3000 - 1500,
                y: Math.random() * 3000 - 1500,
                z: Math.random() * 2000 - 1000,
                size: Math.random() * 2 + 0.5,
                brightness: Math.random()
            });
        }

        // ç»˜åˆ¶æ˜Ÿç³»
        function drawGalaxy() {
            const centerX = galaxyCanvas.width / 2;
            const centerY = galaxyCanvas.height / 2;

            galaxyCtx.fillStyle = 'rgba(0, 0, 10, 0.3)';
            galaxyCtx.fillRect(0, 0, galaxyCanvas.width, galaxyCanvas.height);

            stars.forEach(star => {
                const projectedZ = star.z * galaxyScale;
                const scale = 500 / (500 + projectedZ);
                const x = centerX + star.x * scale * galaxyScale;
                const y = centerY + star.y * scale * galaxyScale;
                const size = star.size * scale;
                const alpha = Math.min(1, scale * star.brightness);

                const hue = (star.z + 1000) / 2000 * 60 + 200;
                galaxyCtx.fillStyle = `hsla(${hue}, 80%, 80%, ${alpha})`;
                galaxyCtx.beginPath();
                galaxyCtx.arc(x, y, Math.max(0.5, size), 0, Math.PI * 2);
                galaxyCtx.fill();
            });

            const time = Date.now() * 0.001;
            for (let arm = 0; arm < 4; arm++) {
                const armAngle = (arm / 4) * Math.PI * 2;
                for (let i = 0; i < 100; i++) {
                    const t = i / 100;
                    const spiralAngle = armAngle + t * 4 + time * 0.1;
                    const distance = t * 600 * galaxyScale;
                    const x = centerX + Math.cos(spiralAngle) * distance;
                    const y = centerY + Math.sin(spiralAngle) * distance;
                    const alpha = (1 - t) * 0.5;
                    const size = (1 - t) * 3 + 1;

                    galaxyCtx.fillStyle = `rgba(255, 200, 100, ${alpha})`;
                    galaxyCtx.beginPath();
                    galaxyCtx.arc(x, y, size, 0, Math.PI * 2);
                    galaxyCtx.fill();
                }
            }

            const coreGradient = galaxyCtx.createRadialGradient(centerX, centerY, 0, centerX, centerY, 80 * galaxyScale);
            coreGradient.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
            coreGradient.addColorStop(0.3, 'rgba(200, 150, 255, 0.6)');
            coreGradient.addColorStop(0.7, 'rgba(100, 50, 200, 0.3)');
            coreGradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
            galaxyCtx.fillStyle = coreGradient;
            galaxyCtx.beginPath();
            galaxyCtx.arc(centerX, centerY, 80 * galaxyScale, 0, Math.PI * 2);
            galaxyCtx.fill();

            requestAnimationFrame(drawGalaxy);
        }
        drawGalaxy();

        // æ‰‹åŠ¿æ£€æµ‹
        const videoElement = document.getElementById('camera-preview');
        const gestureStatus = document.getElementById('gesture-status');
        const loadingElement = document.getElementById('loading');

        let lastPinchDistance = null;

        function isPinchGesture(landmarks) {
            const thumbTip = landmarks[4];
            const indexTip = landmarks[8];
            const middleTip = landmarks[12];
            const ringTip = landmarks[16];
            const pinkyTip = landmarks[20];
            const wrist = landmarks[0];

            const distance = (a, b) => Math.sqrt(Math.pow(a.x - b.x, 2) + Math.pow(a.y - b.y, 2));

            const thumbIndexDistance = distance(thumbTip, indexTip);
            const wristMiddleDistance = distance(wrist, middleTip);
            const normalizedDistance = thumbIndexDistance / wristMiddleDistance;

            const isIndexExtended = distance(indexTip, wrist) > distance(landmarks[6], wrist) * 1.2;
            const isMiddleExtended = distance(middleTip, wrist) > distance(landmarks[10], wrist) * 1.2;
            const isRingExtended = distance(ringTip, wrist) > distance(landmarks[14], wrist) * 1.2;
            const isPinkyExtended = distance(pinkyTip, wrist) > distance(landmarks[18], wrist) * 1.2;

            const extendedFingers = [isIndexExtended, isMiddleExtended, isRingExtended, isPinkyExtended].filter(Boolean).length;

            return {
                isPinching: normalizedDistance < 0.15 && extendedFingers < 2,
                isOpen: normalizedDistance > 0.35 && extendedFingers >= 3,
                distance: normalizedDistance
            };
        }

        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const gesture = isPinchGesture(landmarks);

                if (gesture.isOpen) {
                    gestureStatus.textContent = 'âœ‹ æ£€æµ‹åˆ°å¼ å¼€æ‰‹åŠ¿ - æ”¾å¤§ä¸­...';
                    gestureStatus.style.color = '#00ff00';
                    galaxyScale = Math.min(maxScale, galaxyScale * 1.02);
                } else if (gesture.isPinching) {
                    gestureStatus.textContent = 'âœŠ æ£€æµ‹åˆ°æåˆæ‰‹åŠ¿ - ç¼©å°ä¸­...';
                    gestureStatus.style.color = '#ff6600';
                    galaxyScale = Math.max(minScale, galaxyScale * 0.98);
                } else {
                    gestureStatus.textContent = 'ğŸ¤š ç§»åŠ¨æ‰‹æŒ‡æ¥æ§åˆ¶ç¼©æ”¾';
                    gestureStatus.style.color = '#ffffff';
                }
            } else {
                gestureStatus.textContent = 'ğŸ‘‹ è¯·å°†æ‰‹æ”¾å…¥æ‘„åƒå¤´è§†é‡';
                gestureStatus.style.color = '#ffff00';
            }
        }

        const hands = new Hands({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 }
                });
                videoElement.srcObject = stream;

                videoElement.onloadedmetadata = () => {
                    const camera = new Camera(videoElement, {
                        onFrame: async () => {
                            await hands.send({ image: videoElement });
                        },
                        width: 640,
                        height: 480
                    });
                    camera.start();
                    loadingElement.style.display = 'none';
                };
            } catch (error) {
                loadingElement.innerHTML = `
                    <div>æ— æ³•è®¿é—®æ‘„åƒå¤´</div>
                    <div style="font-size: 16px; margin-top: 10px;">è¯·ç¡®ä¿å·²æˆäºˆæ‘„åƒå¤´æƒé™</div>
                `;
                console.error('Camera error:', error);
            }
        }

        startCamera();
    </script>
</body>
</html>